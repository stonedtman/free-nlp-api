<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script>
    try {
      if (isindex) {
      }
    } catch (e) {
      window.location.href = "/dist/index.html";
    }
  </script>
  <link rel="stylesheet" href="/dist/assets/css/speechRecognition/voiceRecognize.css" />
  <link href="/dist/assets/common/public.css" rel="stylesheet" />

  <style>
    #cylindrical_chart text {
      fill: #6c757d !important;
    }

    #compare_pagination {
      padding: 10px 10px 0;
      text-align: right;
    }

    #cylindrical_chart {
      margin-top: 25px;
      padding: 1.25rem;
      background: #fff;
    }

    .table-responsive .col-tab-list-2 tr,
    .table-responsive .col-tab-list-2 tr td {
      width: 50%;
    }

    .table-responsive .col-tab-list-2 tr th {
      width: 50%;
    }

    #comparative_tab div {
      display: flex;
      align-items: center;
    }

    .compare_result {
      width: 100%;
      min-height: 200px;
      border: 1px solid rgba(204, 204, 204, 1);
      padding: 15px;
    }
  </style>
</head>

<body>
  <div>
    <div class="row page-title align-items-center">
      <div class="col-sm-4 col-xl-6">
        <h4 class="mb-1 mt-0">实时语音识别</h4>
      </div>
    </div>
    <div class="col-xl-12">
      <div class="card blank">
        <div class="card-body p-0 blank-body">
          <div class="edit_online">
            <div class="edit_name">
              <span>接口说明：</span><span>基于深度学习的端到端建模，将音频流实时识别为文字，并返回每句话的开始和结束时间，适用于长句语音输入、音视频字幕、会议等场景。</span>
            </div>
          </div>

          <div class="text_area">
            <div class="compare_left">
              <div class="text_title">语音输入</div>
              <div class="input_voice">
                <div class="recognize_box" onclick="controlRecording()">
                  <button class="record_btn">
                    <i class="uil-microphone"></i>
                  </button>
                  <div class="recognize_btn" onclick="startRecognize()">开始识别</div>
                  <div class="recognize_btn" onclick="stopRecognize()">停止识别</div>
                  <div class="recognize_tip">实时得到识别结果</div>
                </div>

              </div>
            </div>
            <div class="compare_right">
              <div class="text_title">实时语音识别</div>
              <textarea class="recognize_text form-control" placeholder="点击停止识别按钮后，说的话将会实时识别成文字输出在这里 ..."
                disabled></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="analysis_online">
      <div class="analysis_item">
        <div class="item_name">接口请求地址</div>
        <div class="card mt-1">
          <div class="card-body">
            <ul class="nav nav-tabs">
              <li class="nav-item">
                <a href="#addressParameter" data-toggle="tab" aria-expanded="false" class="nav-link active">
                  <span class="d-block d-sm-none"><i class="uil-file-upload-alt"></i></span>
                  <span class="d-none d-sm-block">请求参数</span>
                </a>
              </li>
              <li class="nav-item">
                <a href="#addressExample" data-toggle="tab" aria-expanded="true" class="nav-link">
                  <span class="d-block d-sm-none"><i class="uil-file-alt"></i></span>
                  <span class="d-none d-sm-block">请求密钥</span>
                </a>
              </li>
            </ul>
            <div class="tab-content p-3 text-muted">
              <div class="tab-pane show active" id="addressParameter">
                <div class="table-responsive">
                  <table class="table table-hover table-nowrap mb-0">
                    <thead>
                      <tr>
                        <th>名称</th>
                        <th>请求示例</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>请求地址</td>
                        <td>
                          <a class="request_address" target="_blank"></a>
                        </td>
                      </tr>
                      <tr>
                        <td>请求方式</td>
                        <td>websocket</td>
                      </tr>
                      <tr>
                        <td>请求格式</td>
                        <td>JSON</td>
                      </tr>
                      <tr>
                        <td>批量请求</td>
                        <td>不支持</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="tab-pane" id="addressExample">
                <div class="table-responsive">
                  <table class="table table-hover table-nowrap mb-0">
                    <thead>
                      <tr>
                        <th>名称</th>
                        <th>请求示例</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>Sec-Websocket-Protocol</td>
                        <td class="secret_obj"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="analysis_item">
        <div class="item_name">接口请求参数</div>
        <div class="card mt-1">
          <div class="card-body">
            <ul class="nav nav-tabs">
              <li class="nav-item">
                <a href="#parameter" data-toggle="tab" aria-expanded="false" class="nav-link active">
                  <span class="d-block d-sm-none"><i class="uil-file-upload-alt"></i></span>
                  <span class="d-none d-sm-block">请求参数</span>
                </a>
              </li>
              <li class="nav-item">
                <a href="#example" data-toggle="tab" aria-expanded="true" class="nav-link">
                  <span class="d-block d-sm-none"><i class="uil-file-alt"></i></span>
                  <span class="d-none d-sm-block">请求示例</span>
                </a>
              </li>
            </ul>
            <div class="tab-content p-3 text-muted">
              <div class="tab-pane show active" id="parameter">
                <div class="table-responsive">
                  <table class="table table-hover table-nowrap mb-0">
                    <thead>
                      <tr>
                        <th>请求参数</th>
                        <th>数据类型</th>
                        <th>描述</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>voice</td>
                        <td>binary</td>
                        <td>待识别的声音文件。声音大小必须在10M以内，支持wav/m4a/mp3/mp4。</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="tab-pane" id="example">
                <pre id="result"></pre>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="analysis_item">
        <div class="item_name">接口返回内容</div>
        <div class="card mt-1">
          <div class="card-body">
            <ul class="nav nav-tabs">
              <li class="nav-item">
                <a href="#returnparameter" data-toggle="tab" aria-expanded="false" class="nav-link active">
                  <span class="d-block d-sm-none"><i class="uil-file-upload-alt"></i></span>
                  <span class="d-none d-sm-block">返回结果</span>
                </a>
              </li>
              <li class="nav-item">
                <a href="#returnexample" data-toggle="tab" aria-expanded="true" class="nav-link">
                  <span class="d-block d-sm-none"><i class="uil-file-alt"></i></span>
                  <span class="d-none d-sm-block">返回示例</span>
                </a>
              </li>
            </ul>
            <div class="tab-content p-3 text-muted">
              <div class="tab-pane show active" id="returnparameter">
                <div class="table-responsive">
                  <table class="table table-hover table-nowrap mb-0">
                    <thead>
                      <tr>
                        <th>返回参数</th>
                        <th>数据类型</th>
                        <th>描述</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>text</td>
                        <td>string</td>
                        <td>语音转换的文字</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="tab-pane" id="returnexample">
                <pre id="returnresult"></pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/dist/assets/common/public.js"></script>
  <script src="/dist/assets/js/pages/speechRecognition/recorder.mp3.min.js"></script>

  <script>
    $(".request_address").attr("href", wsAPI + "/asr");
    $(".request_address").html(wsAPI + "/asr");

    var ws = null; //实现WebSocket 
    var record = null; //多媒体对象，用来处理音频

    function init(rec) {
      record = rec;
    }


    //录音对象
    var Recorder = function (stream) {
      var sampleBits = 16; //输出采样数位 8, 16
      var sampleRate = 8000; //输出采样率
      var context = new AudioContext();
      var audioInput = context.createMediaStreamSource(stream);
      var recorder = context.createScriptProcessor(4096, 1, 1);
      var audioData = {
        size: 0, //录音文件长度
        buffer: [], //录音缓存
        inputSampleRate: 48000, //输入采样率
        inputSampleBits: 16, //输入采样数位 8, 16
        outputSampleRate: sampleRate, //输出采样数位
        oututSampleBits: sampleBits, //输出采样率
        clear: function () {
          this.buffer = [];
          this.size = 0;
        },
        input: function (data) {
          this.buffer.push(new Float32Array(data));
          this.size += data.length;
        },
        compress: function () { //合并压缩
          //合并
          var data = new Float32Array(this.size);
          var offset = 0;
          for (var i = 0; i < this.buffer.length; i++) {
            data.set(this.buffer[i], offset);
            offset += this.buffer[i].length;
          }
          //压缩
          var compression = parseInt(this.inputSampleRate / this.outputSampleRate);
          var length = data.length / compression;
          var result = new Float32Array(length);
          var index = 0,
            j = 0;
          while (index < length) {
            result[index] = data[j];
            j += compression;
            index++;
          }
          return result;
        },
        encodePCM: function () { //这里不对采集到的数据进行其他格式处理，如有需要均交给服务器端处理。
          var sampleRate = Math.min(this.inputSampleRate, this.outputSampleRate);
          var sampleBits = Math.min(this.inputSampleBits, this.oututSampleBits);
          var bytes = this.compress();
          var dataLength = bytes.length * (sampleBits / 8);
          var buffer = new ArrayBuffer(dataLength);
          var data = new DataView(buffer);
          var offset = 0;
          for (var i = 0; i < bytes.length; i++, offset += 2) {
            var s = Math.max(-1, Math.min(1, bytes[i]));
            data.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
          }
          return new Blob([data]);
        }
      };

      var sendData = function () { //对以获取的数据进行处理(分包)
        var reader = new FileReader();
        reader.onload = e => {
          var outbuffer = e.target.result;
          var arr = new Int8Array(outbuffer);
          if (arr.length > 0) {
            var tmparr = new Int8Array(1024);
            var j = 0;
            for (var i = 0; i < arr.byteLength; i++) {
              tmparr[j++] = arr[i];
              if (((i + 1) % 1024) == 0) {
                ws.send(tmparr);
                console.log(tmparr, "发送音频流")
                if (arr.byteLength - i - 1 >= 1024) {
                  tmparr = new Int8Array(1024);
                } else {
                  tmparr = new Int8Array(arr.byteLength - i - 1);
                }
                j = 0;
              }
              if ((i + 1 == arr.byteLength) && ((i + 1) % 1024) != 0) {
                ws.send(tmparr);
                console.log(tmparr, "发送音频流")
              }
            }
          }
        };
        reader.readAsArrayBuffer(audioData.encodePCM());
        audioData.clear();//每次发送完成则清理掉旧数据
      };

      this.start = function () {
        audioInput.connect(recorder);
        recorder.connect(context.destination);
      }

      this.stop = function () {
        recorder.disconnect();
      }

      this.getBlob = function () {
        return audioData.encodePCM();
      }

      this.clear = function () {
        audioData.clear();
      }

      recorder.onaudioprocess = function (e) {
        var inputBuffer = e.inputBuffer.getChannelData(0);
        audioData.input(inputBuffer);
        sendData();
      }
    }


    function startRecognize() {
      // 老的浏览器可能根本没有实现 mediaDevices，所以我们可以先设置一个空的对象
      if (navigator.mediaDevices === undefined) {
        navigator.mediaDevices = {};
      }

      // 一些浏览器部分支持 mediaDevices。我们不能直接给对象设置 getUserMedia
      // 因为这样可能会覆盖已有的属性。这里我们只会在没有 getUserMedia 属性的时候添加它。
      if (navigator.mediaDevices.getUserMedia === undefined) {
        navigator.mediaDevices.getUserMedia = function (constraints) {

          // 首先，如果有 getUserMedia 的话，就获得它
          var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

          // 一些浏览器根本没实现它 - 那么就返回一个 error 到 promise 的 reject 来保持一个统一的接口
          if (!getUserMedia) {
            return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
          }

          // 否则，为老的 navigator.getUserMedia 方法包裹一个 Promise
          return new Promise(function (resolve, reject) {
            getUserMedia.call(navigator, constraints, resolve, reject);
          });
        }
      }

      if (navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ audio: true })
          .then(function (stream) {
            $(".record_btn").addClass("active_use");
            $(".recognize_btn").eq(0).css("display", "none");
            $(".recognize_btn").eq(1).css("display", "block");

            init(new Recorder(stream));
            console.log('开始对讲');
            useWebSocket();
          })
          .catch(function (err) {
            alert("获取麦克风权限失败");
            console.log('获取麦克风权限失败：', err);
          });
      }

    }

    function useWebSocket() {
      ws = new WebSocket(wsAPI);
      ws.binaryType = 'arraybuffer'; //传输的是 ArrayBuffer 类型的数据
      ws.onopen = function () {
        console.log('握手成功');
        if (ws.readyState == 1) { //ws进入连接状态，则每隔500毫秒发送一包数据
          record.start();
        }

      };

      ws.onmessage = function (msg) {
        console.log(msg)
      }

      ws.onerror = function (err) {
        console.log(err)
      }
    }

    function stopRecognize() {
      ws.close();
      record.stop();
      console.log('关闭对讲以及WebSocket');

      $(".record_btn").removeClass("active_use");
      $(".recognize_btn").eq(1).css("display", "none");
      $(".recognize_btn").eq(0).css("display", "block");
    }

    var isOpen = false;
    function controlRecording() {
      if (isOpen) {
        stopRecognize();
        isOpen = false;
      } else {
        startRecognize();
        isOpen = true;
      }
    }

  </script>
</body>

</html>