<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script>
        try {
            if (isindex) {
            }
        } catch (e) {
            window.location.href = "/dist/index.html";
        }
    </script>
    <link rel="stylesheet" href="/dist/assets/common/public.css" />
    <link rel="stylesheet" href="/dist/assets/css/faceCheck/faceSearch.css">
</head>

<body>
    <div>
        <div class="row page-title align-items-center">
            <div class="col-sm-4 col-xl-6">
                <nav aria-label="breadcrumb">
                    <ul class="breadcrumb">
                        <li class="breadcrumb-item">人脸识别</li>
                        <li class="breadcrumb-item active" aria-current="page">
                            人脸搜索
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="col-sm-4 col-xl-6 disposition-entrance">

            </div>
        </div>
        <div class="col-xl-12">
            <div class="card blank">
                <div class="card-body p-0 blank-body">
                    <div class="edit_online">
                        <div class="edit_name">
                            <span>接口介绍：</span><span>通过识别和追踪图像中的人脸,将其与已知的人脸数据库中的数据进行比对,以确定是否匹配。通常使用的是自己的人脸数据库,与待识别的人脸进行比对,以确定其是否与已知人员一致。
                            </span>
                        </div>
                        <div class="row">
                            <div class="col-xl-8">
                                <div class="images_input">
                                    <div class="images_input_top">
                                        <div class="images_input_title">上传图像</div>
                                    </div>
                                    <div class="images_input_bottom">
                                        <div class="images_show hide"><img src="" alt=""></div>
                                        <div class="images_upload">
                                            <div class="upload_icon"><i class="uil uil-plus"></i></div>
                                            <div class="upload_tip">请上传一张照片，大小不要超过10M</div>
                                        </div>
                                        <input type="file" class="fileUpload upload_box" accept=".jpg,.png,.bmp,.jpeg">
                                    </div>

                                </div>
                            </div>
                            <div class="col-xl-4">
                                <div class="images_config">
                                    <div class="images_config_top">
                                        <div class="images_config_title">检索参数</div>
                                        <div class="images_config_bottom">
                                            <div class="form-group">
                                                <label for="">返回搜索结果置信度</label><span class="default-value"><span
                                                        class="default-number"></span>%</span>
                                                <input type="range" class="form-control-range score-min" min="0"
                                                    max="100" step="1" value="" oninput="getScoreMin()">
                                            </div>

                                            <div class="form-group">
                                                <label for="">要检索的数据集</label>
                                                <select class="custom-select album-list" style="display: block;"
                                                    onchange="pickPhotoAlbum()">

                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="">返回搜索结果数量</label><span class="default-value"><span
                                                        class="default-number"></span>张</span>
                                                <input type="range" class="form-control-range return-size" min="1"
                                                    max="100" step="1" value="" oninput="getReturnSize()">
                                            </div>

                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-4 col-xl-6">
                                <div class="btn btn-primary search_online">在线搜索</div>
                            </div>
                            <div class="col-sm-4 col-xl-6 text-right">
                                <input type="file" class="fileUpload upload_btn" accept=".jpg,.png,.bmp,.jpeg" />
                                <div class="uploadimg btn btn-primary">上传图片</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="analysis_online">
            <div class="analysis_item">
                <div class="item_name">人脸搜索结果</div>
                <div class="card mt-1 prompt">
                    <div class="card-body blank-body">
                        <div class="step_tip">
                            人脸检索结果按照相似度排序，可以单击查看完整图像
                        </div>
                        <div class="images_list_show hide">

                        </div>
                        <div id="pagination"></div>
                    </div>
                </div>


            </div>
            <div class="analysis_item">
                <div class="item_name">接口请求地址</div>
                <div class="card mt-1">
                    <div class="card-body">
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a href="#addressParameter" data-toggle="tab" aria-expanded="false"
                                    class="nav-link active">
                                    <span class="d-block d-sm-none"><i class="uil-file-upload-alt"></i></span>
                                    <span class="d-none d-sm-block">请求参数</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#addressExample" data-toggle="tab" aria-expanded="true" class="nav-link">
                                    <span class="d-block d-sm-none"><i class="uil-file-alt"></i></span>
                                    <span class="d-none d-sm-block">请求密钥</span>
                                </a>
                            </li>
                        </ul>
                        <div class="tab-content p-3 text-muted">
                            <div class="tab-pane show active" id="addressParameter">
                                <div class="table-responsive">
                                    <table class="table table-hover table-nowrap mb-0">
                                        <thead>
                                            <tr>
                                                <th>名称</th>
                                                <th>请求示例</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>请求地址</td>
                                                <td>
                                                    <a class="request_address" target="_blank"></a>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>请求方式</td>
                                                <td>post</td>
                                            </tr>
                                            <tr>
                                                <td>请求类型</td>
                                                <td>body</td>
                                            </tr>
                                            <tr>
                                                <td>请求格式</td>
                                                <td>JSON</td>
                                            </tr>
                                            <tr>
                                                <td>批量请求</td>
                                                <td>不支持</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane" id="addressExample">
                                <div class="table-responsive">
                                    <table class="table table-hover table-nowrap mb-0">
                                        <thead>
                                            <tr>
                                                <th>名称</th>
                                                <th>请求示例</th>

                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>secret-id</td>
                                                <td class="secret_id"></td>
                                            </tr>
                                            <tr>
                                                <td>secret-key</td>
                                                <td class="secret_key"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="analysis_item">
                <div class="item_name">接口请求参数</div>
                <div class="card mt-1">
                    <div class="card-body">
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a href="#parameter" data-toggle="tab" aria-expanded="false" class="nav-link active">
                                    <span class="d-block d-sm-none"><i class="uil-file-upload-alt"></i></span>
                                    <span class="d-none d-sm-block">请求参数</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#example" data-toggle="tab" aria-expanded="true" class="nav-link">
                                    <span class="d-block d-sm-none"><i class="uil-file-alt"></i></span>
                                    <span class="d-none d-sm-block">请求示例</span>
                                </a>
                            </li>
                        </ul>
                        <div class="tab-content p-3 text-muted">
                            <div class="tab-pane show active" id="parameter">
                                <div class="table-responsive">
                                    <table class="table table-hover table-nowrap mb-0">
                                        <thead>
                                            <tr>
                                                <th>请求参数</th>
                                                <th>数据类型</th>
                                                <th>描述</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>image</td>
                                                <td>binary</td>
                                                <td>
                                                    待查询的图片。图片大小必须在10M以内，支持jpg/png/bmp/jpeg格式。
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>albumId</td>
                                                <td>int</td>
                                                <td>
                                                    相册id
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>topk</td>
                                                <td>int</td>
                                                <td>
                                                    返回搜索结果数量
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>confidence</td>
                                                <td>float</td>
                                                <td>
                                                    返回搜索结果置信度(只返回大于该置信度的搜索结果)
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane" id="example">
                                <pre id="result"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="analysis_item">
                <div class="item_name">接口返回内容</div>
                <div class="card mt-1">
                    <div class="card-body">
                        <ul class="nav nav-tabs">
                            <li class="nav-item">
                                <a href="#returnparameter" data-toggle="tab" aria-expanded="false"
                                    class="nav-link active">
                                    <span class="d-block d-sm-none"><i class="uil-file-upload-alt"></i></span>
                                    <span class="d-none d-sm-block">返回结果</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a href="#returnexample" data-toggle="tab" aria-expanded="true" class="nav-link">
                                    <span class="d-block d-sm-none"><i class="uil-file-alt"></i></span>
                                    <span class="d-none d-sm-block">返回示例</span>
                                </a>
                            </li>
                        </ul>
                        <div class="tab-content p-3 text-muted">
                            <div class="tab-pane show active" id="returnparameter">
                                <div class="table-responsive">
                                    <table class="table table-hover table-nowrap mb-0">
                                        <thead>
                                            <tr>
                                                <th>返回参数</th>
                                                <th>数据类型</th>
                                                <th>描述</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>img</td>
                                                <td>string</td>
                                                <td>检索的图片的访问地址</td>
                                            </tr>
                                            <tr>
                                                <td>score</td>
                                                <td>float</td>
                                                <td>检索的图片和上传的图片的相似度</td>
                                            </tr>
                                            <tr>
                                                <td>location</td>
                                                <td>array</td>
                                                <td>人脸在图像中的坐标</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="tab-pane" id="returnexample">
                                <pre id="returnresult"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="zoominImage" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" style="width: 1000px;">
                <div class="modal-content">
                    <div class="modal-header" style="padding: 20px 20px 10px; border: none">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" style="text-align: center;height: 600px;">
                        <div class="img">
                            <img class="enlarge-img" src="" alt="" />
                            <div class="square-frame">
                                <div class="img-confidence"><span>置信度：</span><span class="value"></span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script src="/dist/assets/common/public.js"></script>
<script src="/dist/assets/js/pages/faceCheck/faceSearch.js"></script>
<script>
    $(".request_address").attr("href", requestAddress + "/faceSearch")
    $(".request_address").html(requestAddress + "/faceSearch")

    var fileUploads = document.querySelectorAll(".fileUpload");
    var successFile;
    for (var i = 0; i < fileUploads.length; i++) {
        fileUploads[i].addEventListener("change", function (e) {
            // console.log(e.target.files[0]);
            var file = e.target.files[0];
            var size = file.size / 1024 / 1024;

            if (file) {
                if (size < 10) {
                    successFile = file;
                    $(".images_show").removeClass("hide");
                    $(".images_upload").addClass("hide");
                    var reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = function (e) {
                        //图片路径设置为读取的图片
                        $(".images_show img").attr("src", e.target.result);
                    };
                } else {
                    $(".message-error .message_content").html("上传的图片大小不能超过10M");
                    $(".message-error").removeClass("message-hide");
                    setTimeout(() => {
                        $(".message-error").addClass("message-hide");
                    }, 2000);
                }

            }


        });

    }

    //相册集
    function getAlbumList() {
        $.ajax({
            method: "GET",
            url: configAPI + "/searchFace/pageAll",
            data: {},
            contentType: "application/json",
            success: function (res) {
                if (res.code == 200) {
                    var strHtml = "<option selected hidden>请选择数据集</option>";
                    res.result.data.forEach((item, index) => {
                        strHtml += `<option class="option" id="${item.id}">${item.albumName}</option>`
                    })
                    $(".album-list").html(strHtml)
                }
            },
        });
    }
    getAlbumList();




    var score = 50;//返回结果置信度
    $(".default-number").eq(0).html(score);

    function getScoreMin() {
        var score_min = $(".score-min").val();
        $(".default-number").eq(0).html(score_min);
        $(".score-min").css("background-size", score_min + "%");
        score = score_min;
    }

    var albumId = "";//相册Id
    function pickPhotoAlbum() {
        var selectDom = document.querySelector(".album-list");
        var index = selectDom.selectedIndex; //获取选中项的索引
        albumId = $(".album-list .option").eq(index - 1).attr("id");
    }

    var topk = 50;//返回结果数量
    $(".default-number").eq(1).html(topk);

    function getReturnSize() {
        var return_size = $(".return-size").val();
        $(".default-number").eq(1).html(return_size);
        $(".return-size").css("background-size", return_size + "%");
        topk = return_size;
    }



    function zoomin(item) {
        $("#zoominImage").modal("show");
        $(".enlarge-img").attr("src", item.img)
        $(".img-confidence .value").html(item.score)
        setTimeout(() => {
            var frameInfo = calcElementInfo(item);
            $(".square-frame").css("width", frameInfo.width + 'px');
            $(".square-frame").css("height", frameInfo.height + 'px');
            $(".square-frame").css("left", frameInfo.left + 'px');
            $(".square-frame").css("top", frameInfo.top + 'px');
        }, 200)
    }


    function calcElementInfo(item) {
        var img = document.createElement("img");
        img.src = item.img;
        img.style.display = 'none';
        img.classList.add("original-img");
        document.body.appendChild(img);
        var oldWidth = $(".original-img").width();
        var oldHeight = $(".original-img").height();
        document.body.removeChild(img);
        var width = $(".enlarge-img").width();
        var height = $(".enlarge-img").height();

        var location = JSON.parse(item.location);
        var frameWidth = (location[1] - location[3]) * (width / oldWidth);
        var frameHeight = (location[2] - location[0]) * (height / oldHeight);
        var frameLeft = location[3] * (width / oldWidth)
        var frameTop = location[0] * (height / oldHeight);

        var obj = { width: frameWidth, height: frameHeight, left: frameLeft, top: frameTop };
        return obj;
    }

    function imagesManage() {
        window.location.href = "/dist/assets/disposition/index.html?menu=8"
    }


    var imagesList = [];
    var page = 1;

    function pagination(total) {
        layui.use("laypage", function () {
            var laypage = layui.laypage;

            //执行一个laypage实例
            laypage.render({
                elem: "pagination",
                count: total,
                limit: 20,
                groups: 3,
                layout: ["count", "prev", "page", "next", "skip"],
                jump: function (obj) {
                    if (page == obj.curr) {
                        return;
                    }
                    page = obj.curr;

                    var strHtml = "";
                    imagesList.slice((page - 1) * 20, page * 20).forEach((item, index) => {
                        strHtml += `<div class="images_item" onclick="zoomin(${JSON.stringify(
                            item
                        ).replace(/"/g, "&quot;")})">
               <img src="${item.img}" alt="">
           </div>`;
                    });
                    $(".images_list_show").html(strHtml);
                },
                theme: "#5369f8",
            });
        });
    }

</script>

</html>