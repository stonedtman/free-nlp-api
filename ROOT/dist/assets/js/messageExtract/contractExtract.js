$(".request_address").attr("href", requestAddress + "/extractContract");
$(".request_address").html(requestAddress + "/extractContract");

var current = 0;
var exampleList = [
  "恒洋广场商务中心租房合同\n甲方：山西恺振文化传媒有限公司      甲方地址：恒洋广场商务中心\n乙方：中国联合网络通信有限公司忻州市分公司      乙方地址：忻州市华侨路56大地大厦\n签订时间：2008年4月18日\n双方经友好协商，根据《合同法》及国家、当地政府对房屋租赁的有关规定，就租房屋一事达成以下协议。\n第一部分 房屋概况\n第一条 甲方保证向乙方出租的房屋系(本人，共有)拥有完全所有权和使用权，设房屋它项权利有\n(如果房屋是共有，则还应增加：已经共有人同意，附书面同意声明。如果是委托赁，应有房屋所有权人与受托人的委托协议书)\n第二条 租赁期限从2008年4月20日至2020年4月20日\n第三条 房屋法律概况\n1、房屋所有权证书登记人：王小伟，身份证号码：112937467573782984553556;\n2、房屋所有权证书编号：NJG-34566477;\n3、土地使用权证书编号：GHT-32454556;\n4、房屋所有权证书上登记的房屋建筑面积：2100平方;5、房屋的使用面积：1983平方",
  "软件开发(委托)合同\n委托方(甲方):海南省交通规费征稽局\n地址: 海南省海口市龙华区杜鹃路1号\n项目联系人: 陈言珂\n联系方式:0898-68682063\n\n受托方(乙方):海南新境界软件有限公司\n项目联系人:林辉\n联系方式:0898-66671188\n地址: 海口市国贸玉沙路国贸中心首层\n\n甲乙双方依据《中华人民共和国民法典》、专家核价结果和其他相关法律法规的规定，本着平等互利的原则，经协商一致，就有关事宜达成如下条款:\n第一条 项目名称、项目内容、技术方法和路线、质量标准\n1.项目名称:新规费管理系统新增功能改造\n2.项目内容:(具体功能描述见附件二)\n(1) 按小时征费算法及相关业务功能、管理功能开发 \n(2) 南港合署办公 \n(3)平价菜多项录入数据共享\n(4) 亲新征费管理系统柴油机动车辆接口校验改造说明:第(1)、(2)项为甲方在 2021 年“查堵点、破难题、促发展”工作中紧急要求开发的事项，第(3)项为甲方根据 2021 年省平价菜保供惠民行动专班和省厅工作部署和要求开发的录入和共享事项，以上3项事项均已在2021年度开发完成并上线运行。第(4)项为落实省交通运输厅和省公安厅交警总队2021年5月8日召开座谈会精神，建立柴油车辆信息共享机制。由于前3个事项均为临时性开发事项，甲方2021年未申请预算资金且无其他资金调剂安排,经申请,省财政 2022 年预算才下达相关经费。\n3.技术方法和路线:与新规费管理系统保持一致。\n4.质量标准:遵照国内行业质量标准。\n\n第二条:甲方应向乙方提供的技术资料及协作事项\n1.技术资料清单:包括但不限于:详细需求、相关国家标准、单位组织机构、机房环境说明等。\n2.提供时间和方式:合同签订后资料的提供与项目的实施同步进行，资料以书面形式提供，并办好交接手续。\n3.其他协作事项:指定专人参与软件系统的建设工作;负责给予乙方业务指导;按期提供系统所需经费;对系统进度、质量进行监督;及时组织并完成验收工作;负责项目开发工作中的协调工作。\n若因甲方提供资料不及时、不完整造成的项目延误，乙方不承担责任。\n\n第三条 合同金额及支付方式\n根据甲方委托的第三方机构对本合同投资估算的核价结果，甲乙双方确定合同总金额为:520,665元,小写金额：52万665元，大写合同金额：伍拾贰万零陆佰陆拾伍元整，本合同以人民币结算。合同款由甲方分期支付乙方。具体支付方式和时间如下:\n1.合同签订后，甲方收到乙方开具的正式有效发票10个工作日内，向乙方支付合同总金额的30%，合计人民币壹拾伍万陆仟壹佰玖拾玖元伍角。\n2.系统部署上线开始试运行后，甲方收到乙方开具的正式有效发票10个工作日内，向乙方支付合同总金额的40%，合计人民币贰拾万捌仟贰佰陆拾陆元整(即¥208,266.00元)。\n3.系统通过竣工验收后，甲方收到乙方开具的正式有效发票10个工作日内，向乙方支付合同总金额的30%，合计人民币壹拾伍万陆仟壹佰玖拾玖元伍角(即¥156,199.50元)。\n\n乙方银行账号信息:\n户名:海南新境界软件有限公司\n账号:46001003636050011732\n开户银行名称:中国建设银行股份有限公司海口国贸支行\n联系地址:海口市国贸玉沙路国贸中心首层\n\n第四条:双方确定因履行本合同应遵守的保密义务\n1.保密内容(包括技术信息和经营信息):\n(1)双方都有责任对对方提供的技术情报、资料数据及商业秘密保密，不得向第三方泄露。\n(2)未经对方同意,任何一方不得以任何形式公开合同及相关附件中任何内容。\n(3)双方在未征得对方同意的情况下，不得向第三方泄露在项目中接触需要保密的情报和资料(包括系统技术文档)。\n(4)任何一方未征得对方同意，不得为任何其他目的而自行使用或允许他人使用从对方获得的信息。\n2.涉密人员范围:项目组成员\n3.保密期限:三年\n4.泄密责任:根据洲密范围及程度追究当事人法律责任\n\n第五条 系统验收\n1.乙方完成软件开发、安装、调试工作后的5个工作日内，应向甲方提出系统部署及试运行申请。\n2.甲方应配合乙方做好系统试运行工作，试运行期间，甲方按照相关技术规范对系统进行测试和试用，在使用过程中出现异常，需记录故障现象，及时与乙方取得联系，并要求乙方在规定的期限内完成整改。\n\n第刘条 双方责任及义务\n甲方责任:\n1.负责给予乙方业务指导，提供完整的业务需求和资料。\n2.按进度提供系统运行所必须的软硬件条件。\n3.对系统进度、质量进行监督，并负责甲方内部各部门的协调工作。\n4.负责及时对乙方提交“软件需求规格说明书”进行签字确认。\n5.乙方软件修改完成后，甲方需积极配合试运行工作，若因甲方不配合使用，导致对软件部分或全部功能模块没有明确的试运行报告，应视作甲方对软件认可，甲方应无条件验收并支付剩余款项。\n6.按本合同的付款条款按时支付所需款项。乙方责任:\n1.合同生效后，在甲方协助下按合同要求完成系统开发、调试、试运行、培训、实施工作。\n2.根据甲方提出的意见进行软件的修改和开发工作，并负责系统的培训及实施工作。\n3.协助甲方做好竣工验收及售后服务工作，对试运行过程中遇到的问题，属于附件“软件功能”和“软件需求规格说明书”范围，应积极解决甲方软件要求;若超出附件“软件功能”和“软件需求规格说明书”范围，应与甲方友好协商解决。\n4.乙方在实施过程中保证对甲方已有系统不造成影响，如产生影响。则乙方负责解决，并提供分析报告。",
];
$("#contract_text").val(exampleList[current]);

function pickOption() {
  var selectDom = document.querySelector(".custom-select");
  var index = selectDom.selectedIndex; //获取选中项的索引
  current = index - 1;
  $("#contract_text").val(exampleList[current]);
}

var fileUpload = document.querySelector(".upload_file");
fileUpload.addEventListener("change", function (e) {
  var file = e.target.files[0];
  if (file) {
    // $("#marklayer .loading").html("上 传 中 ···");
    $("#marklayer").addClass("mark-show"); //加载状态
    var formData = new FormData();
    formData.append("file", file);
    $.ajax({
      method: "POST",
      url: baseAPI + "/extractText",
      headers: {
        "secret-id": secret_id,
        "secret-key": secret_key,
      },
      data: formData,
      contentType: false,
      processData: false,
      success: function (res) {
        $("#marklayer").removeClass("mark-show");
        if (res.code == 200) {
          $("#contract_text").val(res.result);
          $(".upload_file").val("");
          $(".message-success .message_content").html("上传成功");
          $("#changePassword").modal("hide");
          $(".message-success").removeClass("message-hide");
          setTimeout(() => {
            $(".message-success").addClass("message-hide");
          }, 2000);
        }
      },
    });
  }
});

var contractText = $("#contract_text").val().trim();
var requestObj = {
  text: contractText,
};
var returnObj = {
  msg: "合同抽取成功",
  result: [
    {
      合同金额: [
        {
          probability: 0.6532685620340928,
          start: 314,
          end: 323,
          text: "520,665 元",
        },
      ],
      甲方开户行: [
        {
          probability: 0.7597312176461344,
          start: 710,
          end: 728,
          text: "中国建设银行股份有限公司海口国贸支行",
        },
      ],
      乙方地址: [
        {
          probability: 0.28416729014920605,
          start: 734,
          end: 748,
          text: "海口市国贸玉沙路国贸中心首层",
        },
      ],
      金额小写: [
        {
          probability: 0.9437326959528924,
          start: 329,
          end: 339,
          text: "52 万 665 元",
        },
      ],
      乙方开户行: [
        {
          probability: 0.8052491352597002,
          start: 710,
          end: 728,
          text: "中国建设银行股份有限公司海口国贸支行",
        },
      ],
      金额: [
        {
          probability: 0.46032282840388916,
          start: 314,
          end: 323,
          text: "520,665 元",
        },
      ],
      人民币: [
        {
          probability: 0.335768153923226,
          start: 453,
          end: 465,
          text: "壹拾伍万陆仟壹佰玖拾玖元",
        },
      ],
      合同期限: [
        {
          probability: 0.4545681995060562,
          start: 997,
          end: 999,
          text: "三年",
        },
      ],
      金额大写: [
        {
          probability: 0.572299609956417,
          start: 347,
          end: 360,
          text: "伍拾贰万零陆佰陆n拾伍元整",
        },
      ],
    },
  ],
  code: "200",
};
$("#result").html(syntaxHighlight(requestObj));
$("#returnresult").html(syntaxHighlight(returnObj));
var dataList = {
  msg: "合同抽取成功",
  result: [
    {
      合同金额: [
        {
          probability: 0.6532685620340928,
          start: 314,
          end: 323,
          text: "520,665 元",
        },
      ],
      甲方开户行: [
        {
          probability: 0.7597312176461344,
          start: 710,
          end: 728,
          text: "中国建设银行股份有限公司海口国贸支行",
        },
      ],
      乙方地址: [
        {
          probability: 0.28416729014920605,
          start: 734,
          end: 748,
          text: "海口市国贸玉沙路国贸中心首层",
        },
      ],
      金额小写: [
        {
          probability: 0.9437326959528924,
          start: 329,
          end: 339,
          text: "52 万 665 元",
        },
      ],
      乙方开户行: [
        {
          probability: 0.8052491352597002,
          start: 710,
          end: 728,
          text: "中国建设银行股份有限公司海口国贸支行",
        },
      ],
      金额: [
        {
          probability: 0.46032282840388916,
          start: 314,
          end: 323,
          text: "520,665 元",
        },
      ],
      人民币: [
        {
          probability: 0.335768153923226,
          start: 453,
          end: 465,
          text: "壹拾伍万陆仟壹佰玖拾玖元",
        },
      ],
      合同期限: [
        {
          probability: 0.4545681995060562,
          start: 997,
          end: 999,
          text: "三年",
        },
      ],
      金额大写: [
        {
          probability: 0.572299609956417,
          start: 347,
          end: 360,
          text: "伍拾贰万零陆佰陆n拾伍元整",
        },
      ],
    },
  ],
  code: "200",
};

$(".analysis_name").click(function () {
  var contractText = filterXSS($("#contract_text").val().trim());
  if (contractText) {
    $("#marklayer").addClass("mark-show");
    var requestObj = {
      text: contractText,
    };
    var resultJSON = JSON.stringify(requestObj);
    var result = syntaxHighlight(JSON.parse(resultJSON));
    $("#result").html(result);
    $.ajax({
      method: "POST",
      url: baseAPI + "/extractContract",
      headers: {
        "secret-id": secret_id,
        "secret-key": secret_key,
      },
      contentType: "application/json",
      dataType: "json",
      data: resultJSON,
      success: function (res) {
        $("#marklayer").removeClass("mark-show");
        if (res.code == 200) {
          var resJSON = JSON.stringify(res);
          resObj = JSON.parse(resJSON);
          var returnresult = syntaxHighlight(resObj);
          $("#returnresult").html(returnresult);

          if ($(".empty-text").length > 0) {
            $(".empty-text").remove();
          }

          if (res.result.length > 0) {
            // 插入分析列表数据
            var table_data = res.result[0];
            var analysis_list = "";
            var index = 0;
            for (var item in table_data) {
              var text = [];
              table_data[item].forEach((element) => {
                text.push(element.text);
              });

              analysis_list += `<tr>
                              <td>${++index}</td>
                              <td>${item}</td>
                              <td>${text.join("，")}</td>
                              <td>${table_data[item][0].probability}</td>
                            </tr>`;
            }
            //   列表应该往列表后面添加元素,直接html会直接覆盖原来的
            $("#analysis_list").html(analysis_list);
            $(".table-responsive").removeClass("hide");
            $(".prompt").addClass("hide");
          } else {
            $(".prompt .card-body").append(
              `<div class="empty-text">返回结果为空，换段文本再试试吧</div>`
            );
            $(".prompt").removeClass("hide");
            $(".step_tip").addClass("hide");
            $(".prompt .table-responsive").addClass("hide");
          }
        }
      },
    });
  } else {
    $(".message-error .message_content").html("请输入要抽取的内容");
    $(".message-error").removeClass("message-hide");
    setTimeout(() => {
      $(".message-error").addClass("message-hide");
    }, 2000);
  }
});
